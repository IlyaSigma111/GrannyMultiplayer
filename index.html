<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Granny 2D Multiplayer</title>
    <link rel="stylesheet" href="style.css">
    <script type="module" src="firebase.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>üï∑ Granny 2D Multiplayer</h1>
        <div id="menu">
            <button id="createRoomBtn">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
            <div>
                <input type="text" id="roomCode" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã">
                <button id="joinRoomBtn">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
            </div>
            <div id="roomInfo" style="display:none;">
                <p>–ö–æ–º–Ω–∞—Ç–∞: <span id="roomId"></span></p>
                <p>–ò–≥—Ä–æ–∫–æ–≤: <span id="playerCount">1</span>/5</p>
                <button id="startBtn" disabled>–ù–∞—á–∞—Ç—å –∏–≥—Ä—É (–∂–¥–µ–º –∏–≥—Ä–æ–∫–æ–≤...)</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { database, ref, set, onValue, push, update, remove } from './firebase.js';

        let currentRoomId = null;
        let playerId = Math.random().toString(36).substring(2, 10);
        let isGranny = false;

        document.getElementById('createRoomBtn').addEventListener('click', createRoom);
        document.getElementById('joinRoomBtn').addEventListener('click', joinRoom);
        document.getElementById('startBtn').addEventListener('click', startGame);

        function createRoom() {
            const roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
            currentRoomId = roomId;
            
            const roomRef = ref(database, 'rooms/' + roomId);
            set(roomRef, {
                players: {
                    [playerId]: {
                        name: '–ò–≥—Ä–æ–∫_' + playerId.substring(0, 4),
                        isGranny: false,
                        ready: false,
                        joinedAt: Date.now()
                    }
                },
                status: 'waiting',
                createdAt: Date.now(),
                maxPlayers: 5
            }).then(() => {
                document.getElementById('roomId').textContent = roomId;
                document.getElementById('roomInfo').style.display = 'block';
                setupRoomListeners(roomId);
            }).catch(error => {
                console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã:", error);
                alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã: ' + error.message);
            });
        }

        function joinRoom() {
            const roomId = document.getElementById('roomCode').value.trim().toUpperCase();
            if (!roomId) return alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã!');
            
            currentRoomId = roomId;
            const roomRef = ref(database, 'rooms/' + roomId);
            
            onValue(roomRef, (snapshot) => {
                if (!snapshot.exists()) {
                    alert('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
                    return;
                }
                
                const data = snapshot.val();
                if (data.status !== 'waiting') {
                    alert('–ò–≥—Ä–∞ —É–∂–µ –Ω–∞—á–∞–ª–∞—Å—å!');
                    return;
                }
                
                const updates = {};
                updates[`players/${playerId}`] = {
                    name: '–ò–≥—Ä–æ–∫_' + playerId.substring(0, 4),
                    isGranny: false,
                    ready: false,
                    joinedAt: Date.now()
                };
                
                update(roomRef, updates).then(() => {
                    document.getElementById('roomId').textContent = roomId;
                    document.getElementById('roomInfo').style.display = 'block';
                    setupRoomListeners(roomId);
                });
            }, { onlyOnce: true });
        }

        function setupRoomListeners(roomId) {
            const roomRef = ref(database, 'rooms/' + roomId);
            
            onValue(roomRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) {
                    alert('–ö–æ–º–Ω–∞—Ç–∞ —É–¥–∞–ª–µ–Ω–∞!');
                    window.location.reload();
                    return;
                }
                
                const players = data.players || {};
                const playerCount = Object.keys(players).length;
                
                document.getElementById('playerCount').textContent = playerCount;
                
                document.getElementById('startBtn').disabled = playerCount < 2;
                document.getElementById('startBtn').textContent = 
                    playerCount < 2 ? '–ù–∞—á–∞—Ç—å –∏–≥—Ä—É (–∂–¥–µ–º –∏–≥—Ä–æ–∫–æ–≤...)' : '–ù–∞—á–∞—Ç—å –∏–≥—Ä—É!';
                
                if (data.status === 'playing') {
                    for (const [id, player] of Object.entries(players)) {
                        if (player.isGranny) {
                            isGranny = (id === playerId);
                            break;
                        }
                    }
                    window.location.href = `game.html?room=${roomId}&player=${playerId}&granny=${isGranny}`;
                }
            });
        }

        function startGame() {
            if (!currentRoomId) return;
            
            const roomRef = ref(database, 'rooms/' + currentRoomId);
            const playersRef = ref(database, 'rooms/' + currentRoomId + '/players');
            
            onValue(playersRef, (snapshot) => {
                const players = snapshot.val();
                if (!players) return;
                
                const playerIds = Object.keys(players);
                const grannyId = playerIds[Math.floor(Math.random() * playerIds.length)];
                
                const updates = {};
                playerIds.forEach(id => {
                    updates[`players/${id}/isGranny`] = (id === grannyId);
                });
                
                updates['status'] = 'playing';
                updates['startedAt'] = Date.now();
                updates['timer'] = 120;
                
                update(roomRef, updates);
            }, { onlyOnce: true });
        }
    </script>
</body>
</html>
