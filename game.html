<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Granny 2D - –ò–≥—Ä–∞</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="game.css">
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <div class="timer">
                <span id="timer">120</span> —Å–µ–∫
            </div>
            <div class="role">
                –í—ã: <span id="roleText">–í—ã–∂–∏–≤—à–∏–π</span>
            </div>
            <div class="players-online">
                –ò–≥—Ä–æ–∫–æ–≤: <span id="playersCount">1</span>
            </div>
        </div>
        
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <div class="controls">
            <div class="desktop-controls">
                <p>WASD - –¥–≤–∏–≥–∞—Ç—å—Å—è, SPACE - —Å–ø—Ä—è—Ç–∞—Ç—å—Å—è, E - –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å</p>
            </div>
        </div>
        
        <div class="game-log" id="gameLog">
            <p id="debugText">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä—ã...</p>
        </div>
    </div>
    
    <script>
        // === –£–ü–†–û–©–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø –ò–ì–†–´ –î–õ–Ø –¢–ï–°–¢–ê ===
        console.log('=== –ò–ì–†–ê –ó–ê–ü–£–°–ö–ê–ï–¢–°–Ø ===');
        
        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');
        const playerId = urlParams.get('player');
        const isGranny = urlParams.get('granny') === 'true';
        
        console.log('–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:', { roomId, playerId, isGranny });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        document.getElementById('roleText').textContent = isGranny ? 'Granny üëµ' : '–í—ã–∂–∏–≤—à–∏–π üèÉ';
        document.getElementById('roleText').style.color = isGranny ? '#ff4757' : '#00ff88';
        document.getElementById('debugText').textContent = `–ö–æ–º–Ω–∞—Ç–∞: ${roomId}, –ò–≥—Ä–æ–∫: ${playerId}`;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // –ü—Ä–æ—Å—Ç–∞—è –∫–∞—Ä—Ç–∞
        const MAP = {
            gridSize: 40,
            width: 20,
            height: 15
        };
        
        // –ò–≥—Ä–æ–∫
        const player = {
            x: 5 * MAP.gridSize,
            y: 12 * MAP.gridSize,
            color: isGranny ? '#ff0000' : '#00a8ff',
            size: 15
        };
        
        // –î—Ä—É–≥–∏–µ –∏–≥—Ä–æ–∫–∏ (—Ç–µ—Å—Ç–æ–≤—ã–µ)
        const testPlayers = [
            { x: 10 * MAP.gridSize, y: 8 * MAP.gridSize, color: '#00a8ff', size: 15 },
            { x: 15 * MAP.gridSize, y: 5 * MAP.gridSize, color: '#00a8ff', size: 15 }
        ];
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        const keys = {};
        window.addEventListener('keydown', (e) => keys[e.key.toLowerCase()] = true);
        window.addEventListener('keyup', (e) => keys[e.key.toLowerCase()] = false);
        
        // –¢–∞–π–º–µ—Ä
        let gameTime = 120;
        const timerElement = document.getElementById('timer');
        
        const timer = setInterval(() => {
            gameTime--;
            timerElement.textContent = gameTime;
            
            if (gameTime <= 0) {
                clearInterval(timer);
                alert('–í—Ä–µ–º—è –≤—ã—à–ª–æ!');
            }
        }, 1000);
        
        // –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
        function gameLoop() {
            // –û—á–∏—Å—Ç–∫–∞
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // –°–µ—Ç–∫–∞
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            for (let x = 0; x <= MAP.width; x++) {
                ctx.beginPath();
                ctx.moveTo(x * MAP.gridSize, 0);
                ctx.lineTo(x * MAP.gridSize, canvas.height);
                ctx.stroke();
            }
            for (let y = 0; y <= MAP.height; y++) {
                ctx.beginPath();
                ctx.moveTo(0, y * MAP.gridSize);
                ctx.lineTo(canvas.width, y * MAP.gridSize);
                ctx.stroke();
            }
            
            // –î–æ–º (–ø—Ä–æ—Å—Ç–æ–π)
            ctx.fillStyle = '#2a2a2a';
            ctx.fillRect(5 * MAP.gridSize, 5 * MAP.gridSize, 10 * MAP.gridSize, 8 * MAP.gridSize);
            
            // –î–≤–µ—Ä—å
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(10 * MAP.gridSize, 12 * MAP.gridSize, 2 * MAP.gridSize, MAP.gridSize);
            
            // –î–≤–∏–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
            const speed = 3;
            if (keys['w'] || keys['arrowup']) player.y -= speed;
            if (keys['s'] || keys['arrowdown']) player.y += speed;
            if (keys['a'] || keys['arrowleft']) player.x -= speed;
            if (keys['d'] || keys['arrowright']) player.x += speed;
            
            // –ì—Ä–∞–Ω–∏—Ü—ã
            player.x = Math.max(0, Math.min(canvas.width - player.size * 2, player.x));
            player.y = Math.max(0, Math.min(canvas.height - player.size * 2, player.y));
            
            // –†–∏—Å—É–µ–º –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤
            testPlayers.forEach(p => {
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x + player.size, p.y + player.size, p.size, 0, Math.PI * 2);
                ctx.fill();
                
                // –ò–º—è
                ctx.fillStyle = 'white';
                ctx.font = '12px Arial';
                ctx.fillText('–ò–≥—Ä–æ–∫', p.x - 10, p.y - 10);
            });
            
            // –†–∏—Å—É–µ–º —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
            ctx.fillStyle = player.color;
            ctx.beginPath();
            ctx.arc(player.x + player.size, player.y + player.size, player.size, 0, Math.PI * 2);
            ctx.fill();
            
            // –ò–º—è —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
            ctx.fillStyle = 'white';
            ctx.font = '12px Arial';
            ctx.fillText(isGranny ? 'Granny' : '–í—ã', player.x - 10, player.y - 10);
            
            // –ò–Ω—Ñ–æ
            ctx.fillStyle = 'white';
            ctx.font = '14px Arial';
            ctx.fillText(`FPS: ${Math.round(1000/16)}`, 10, 20);
            ctx.fillText(`X: ${Math.round(player.x)}, Y: ${Math.round(player.y)}`, 10, 40);
            
            requestAnimationFrame(gameLoop);
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É
        gameLoop();
        console.log('–ò–≥—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞!');
        
        // –¢–µ—Å—Ç Firebase
        setTimeout(() => {
            console.log('–¢–µ—Å—Ç Firebase...');
            import('./firebase.js').then(module => {
                console.log('Firebase –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–Ω–∞—Ç—É
                const db = module.database;
                const ref = module.ref;
                const onValue = module.onValue;
                
                const roomRef = ref(db, 'rooms/' + roomId);
                onValue(roomRef, (snapshot) => {
                    const data = snapshot.val();
                    console.log('–î–∞–Ω–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã:', data);
                    
                    if (data && data.players) {
                        document.getElementById('playersCount').textContent = 
                            Object.keys(data.players).length;
                    }
                });
                
            }).catch(err => {
                console.error('–û—à–∏–±–∫–∞ Firebase:', err);
                document.getElementById('debugText').textContent += ' | Firebase –æ—à–∏–±–∫–∞';
            });
        }, 1000);
    </script>
</body>
</html>
