<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Granny 2D - Игра</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body, html {
            overflow: hidden;
            height: 100%;
            background: #000;
            font-family: Arial, sans-serif;
        }
        
        .game-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .game-header {
            padding: 10px;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #333;
            color: white;
        }
        
        .header-left, .header-right {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .timer { color: #ffcc00; font-weight: bold; }
        .role { color: #00ff88; }
        .players-online { color: #00a8ff; }
        
        #gameCanvas {
            flex: 1;
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .controls {
            padding: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: #aaa;
            text-align: center;
            font-size: 14px;
        }
        
        .exit-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .debug-info {
            position: fixed;
            top: 70px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            border: 1px solid #444;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDHKz6YuGSYzyO-Sj6IS93C9mV0yX0Yfbg",
            authDomain: "grannymultiplayer.firebaseapp.com",
            databaseURL: "https://grannymultiplayer-default-rtdb.firebaseio.com",
            projectId: "grannymultiplayer",
            storageBucket: "grannymultiplayer.firebasestorage.app",
            messagingSenderId: "678766098712",
            appId: "1:678766098712:web:5dd0ead1e54da25109866d"
        };
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
    </script>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <div class="header-left">
                <div class="timer">Время: <span id="timer">120</span>с</div>
                <div class="role">Вы: <span id="roleText">Выживший</span></div>
                <div class="players-online">Игроков: <span id="playersCount">1</span></div>
            </div>
            <div class="header-right">
                <button class="exit-btn" onclick="window.location.href='index.html'">Выйти</button>
            </div>
        </div>
        
        <canvas id="gameCanvas"></canvas>
        
        <div class="controls">
            WASD/Стрелки - движение | ПРОБЕЛ - спрятаться | F - фонарик
        </div>
        
        <div class="debug-info" id="debugInfo">
            Ожидание игроков...
        </div>
    </div>

    <script>
        // ===== ИГРА С РАБОЧЕЙ СИНХРОНИЗАЦИЕЙ =====
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');
        const playerId = urlParams.get('player');
        const isGranny = urlParams.get('granny') === 'true';
        
        console.log('Загрузка игры:', { roomId, playerId, isGranny });
        
        // Настройка интерфейса
        document.getElementById('roleText').textContent = isGranny ? 'Granny' : 'Выживший';
        document.getElementById('roleText').style.color = isGranny ? '#ff4757' : '#00ff88';
        
        // Канвас
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
        
        // === ПРОСТАЯ КАРТА ===
        const MAP = {
            gridSize: 50,
            width: 24,
            height: 18,
            
            rooms: [
                { id: 'entrance', name: 'Прихожая', x: 8, y: 10, w: 8, h: 6, floor: 1 },
                { id: 'livingroom', name: 'Гостиная', x: 2, y: 6, w: 10, h: 8, floor: 1 },
                { id: 'kitchen', name: 'Кухня', x: 12, y: 8, w: 8, h: 8, floor: 1 },
                { id: 'bedroom', name: 'Спальня', x: 6, y: 2, w: 8, h: 6, floor: 2 }
            ],
            
            objects: [
                // Двери (прозрачные)
                { x: 11, y: 10, type: 'door', floor: 1 },
                { x: 16, y: 11, type: 'door', floor: 1 },
                { x: 7, y: 9, type: 'door', floor: 1 },
                
                // Укрытия
                { x: 10, y: 11, type: 'closet', floor: 1 },
                { x: 14, y: 10, type: 'fridge', floor: 1 },
                { x: 4, y: 7, type: 'sofa', floor: 1 },
                { x: 8, y: 3, type: 'bed', floor: 2 },
                
                // Лестница
                { x: 12, y: 14, type: 'stairs', floor: 1 },
                { x: 12, y: 3, type: 'stairs', floor: 2 }
            ]
        };
        
        // Камера
        const CAMERA = {
            x: 0, y: 0, zoom: 1.2,
            update() {
                const targetX = player.x - canvas.width / 2 / this.zoom;
                const targetY = player.y - canvas.height / 2 / this.zoom;
                this.x += (targetX - this.x) * 0.1;
                this.y += (targetY - this.y) * 0.1;
                
                const maxX = MAP.width * MAP.gridSize - canvas.width / this.zoom;
                const maxY = MAP.height * MAP.gridSize - canvas.height / this.zoom;
                this.x = Math.max(0, Math.min(maxX, this.x));
                this.y = Math.max(0, Math.min(maxY, this.y));
            },
            apply() {
                ctx.setTransform(1, 0, 0, 1, 0, 0);
                ctx.scale(this.zoom, this.zoom);
                ctx.translate(-this.x, -this.y);
            }
        };
        
        // Текущий игрок
        const player = {
            id: playerId,
            x: 10 * MAP.gridSize,
            y: 12 * MAP.gridSize,
            size: 20,
            color: isGranny ? '#ff0000' : '#00a8ff',
            name: isGranny ? 'Granny' : 'Игрок_' + playerId.slice(0,4),
            isGranny: isGranny,
            floor: 1,
            hidden: false,
            speed: isGranny ? 2.5 : 3.5,
            lastUpdate: 0
        };
        
        // Другие игроки
        let otherPlayers = {};
        
        // Управление
        const keys = {};
        window.addEventListener('keydown', (e) => keys[e.key.toLowerCase()] = true);
        window.addEventListener('keyup', (e) => keys[e.key.toLowerCase()] = false);
        
        // Таймер
        let gameTime = 120;
        const timer = setInterval(() => {
            gameTime--;
            document.getElementById('timer').textContent = gameTime;
            if (gameTime <= 0) endGame('Время вышло!');
        }, 1000);
        
        // === FIREBASE СИНХРОНИЗАЦИЯ ===
        function initFirebase() {
            const playerRef = ref(database, `rooms/${roomId}/players/${playerId}`);
            
            // Слушаем всех игроков в комнате
            const playersRef = ref(database, `rooms/${roomId}/players`);
            onValue(playersRef, (snapshot) => {
                const players = snapshot.val() || {};
                const count = Object.keys(players).length;
                document.getElementById('playersCount').textContent = count;
                document.getElementById('debugInfo').innerHTML = 
                    `Игроков в комнате: ${count}<br>` +
                    `Ваш ID: ${playerId}<br>` +
                    `Комната: ${roomId}`;
                
                // Обновляем других игроков
                otherPlayers = {};
                Object.entries(players).forEach(([id, data]) => {
                    if (id !== playerId && data && data.x !== undefined) {
                        otherPlayers[id] = {
                            x: data.x || 0,
                            y: data.y || 0,
                            floor: data.floor || 1,
                            hidden: data.hidden || false,
                            isGranny: data.isGranny || false,
                            name: data.name || 'Игрок',
                            color: data.isGranny ? '#ff0000' : '#00a8ff'
                        };
                    }
                });
            });
            
            // Обновляем свою позицию каждые 100мс
            setInterval(() => {
                if (Date.now() - player.lastUpdate > 100) {
                    update(playerRef, {
                        x: player.x,
                        y: player.y,
                        floor: player.floor,
                        hidden: player.hidden,
                        isGranny: player.isGranny,
                        name: player.name,
                        lastUpdate: Date.now()
                    });
                    player.lastUpdate = Date.now();
                }
            }, 100);
            
            // Очистка при выходе
            window.addEventListener('beforeunload', () => {
                remove(playerRef);
            });
        }
        
        // === ОТРИСОВКА ===
        function drawMap() {
            // Фон
            ctx.fillStyle = '#111';
            ctx.fillRect(CAMERA.x, CAMERA.y, canvas.width / CAMERA.zoom, canvas.height / CAMERA.zoom);
            
            // Комнаты
            MAP.rooms.forEach(room => {
                if (room.floor !== player.floor) return;
                
                const x = room.x * MAP.gridSize;
                const y = room.y * MAP.gridSize;
                const w = room.w * MAP.gridSize;
                const h = room.h * MAP.gridSize;
                
                ctx.fillStyle = '#222';
                ctx.fillRect(x, y, w, h);
                
                ctx.strokeStyle = '#444';
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y, w, h);
                
                ctx.fillStyle = '#888';
                ctx.font = '14px Arial';
                ctx.fillText(room.name, x + 5, y + 20);
            });
            
            // Объекты
            MAP.objects.forEach(obj => {
                if (obj.floor !== player.floor) return;
                
                const x = obj.x * MAP.gridSize;
                const y = obj.y * MAP.gridSize;
                
                switch (obj.type) {
                    case 'door':
                        // ПРОЗРАЧНАЯ ДВЕРЬ
                        ctx.globalAlpha = 0.3;
                        ctx.fillStyle = '#8B4513';
                        ctx.fillRect(x, y, MAP.gridSize, MAP.gridSize);
                        ctx.globalAlpha = 1.0;
                        break;
                        
                    case 'stairs':
                        ctx.fillStyle = '#555';
                        ctx.fillRect(x, y, MAP.gridSize, MAP.gridSize);
                        ctx.fillStyle = '#fff';
                        ctx.font = '20px Arial';
                        ctx.fillText('↑↓', x + 15, y + 35);
                        break;
                }
            });
        }
        
        function drawPlayers() {
            // Другие игроки
            Object.values(otherPlayers).forEach(p => {
                if (p.floor !== player.floor) return;
                
                const x = p.x;
                const y = p.y;
                
                // Тень
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.beginPath();
                ctx.ellipse(x + 10, y + 30, 12, 5, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // Игрок
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(x + 10, y + 10, p.hidden ? 8 : 15, 0, Math.PI * 2);
                ctx.fill();
                
                // Имя
                ctx.fillStyle = '#fff';
                ctx.font = '12px Arial';
                ctx.fillText(p.name, x - 10, y - 5);
                
                // Если спрятан
                if (p.hidden) {
                    ctx.fillStyle = 'rgba(0,0,0,0.5)';
                    ctx.fillRect(x - 5, y - 5, 30, 30);
                }
            });
            
            // Текущий игрок
            const x = player.x;
            const y = player.y;
            
            // Тень
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath();
            ctx.ellipse(x + 10, y + 30, 15, 6, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Игрок
            ctx.fillStyle = player.color;
            ctx.beginPath();
            ctx.arc(x + 10, y + 10, player.hidden ? 10 : player.size/2, 0, Math.PI * 2);
            ctx.fill();
            
            // Имя
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 14px Arial';
            ctx.fillText(player.name + ' (Вы)', x - 15, y - 10);
            
            // Если спрятан
            if (player.hidden) {
                ctx.fillStyle = 'rgba(0,0,0,0.7)';
                ctx.fillRect(x - 10, y - 10, 40, 40);
                ctx.fillStyle = '#fff';
                ctx.font = '12px Arial';
                ctx.fillText('Спрятан', x, y - 15);
            }
        }
        
        // === ИГРОВОЙ ЦИКЛ ===
        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Движение
            if (!player.hidden) {
                if (keys['w'] || keys['arrowup']) player.y -= player.speed;
                if (keys['s'] || keys['arrowdown']) player.y += player.speed;
                if (keys['a'] || keys['arrowleft']) player.x -= player.speed;
                if (keys['d'] || keys['arrowright']) player.x += player.speed;
                
                // Границы
                player.x = Math.max(0, Math.min(MAP.width * MAP.gridSize - player.size, player.x));
                player.y = Math.max(0, Math.min(MAP.height * MAP.gridSize - player.size, player.y));
                
                // Лестницы
                checkStairs();
                
                // Спрятаться
                if (keys[' ']) {
                    const nearHideSpot = checkNearHideSpot();
                    if (nearHideSpot && !player.hidden) {
                        player.hidden = true;
                    }
                }
                
                // Выйти из укрытия
                if (keys['f'] && player.hidden) {
                    player.hidden = false;
                }
            } else {
                // Выйти из укрытия
                if (keys['f']) {
                    player.hidden = false;
                }
            }
            
            // Обновление камеры и отрисовка
            CAMERA.update();
            CAMERA.apply();
            drawMap();
            drawPlayers();
            
            requestAnimationFrame(gameLoop);
        }
        
        function checkStairs() {
            const gridX = Math.floor((player.x + player.size/2) / MAP.gridSize);
            const gridY = Math.floor((player.y + player.size/2) / MAP.gridSize);
            
            for (const obj of MAP.objects.filter(o => o.type === 'stairs')) {
                if (obj.x === gridX && obj.y === gridY) {
                    player.floor = player.floor === 1 ? 2 : 1;
                    
                    if (player.floor === 2) {
                        player.x = 8 * MAP.gridSize;
                        player.y = 4 * MAP.gridSize;
                    } else {
                        player.x = 10 * MAP.gridSize;
                        player.y = 12 * MAP.gridSize;
                    }
                    break;
                }
            }
        }
        
        function checkNearHideSpot() {
            const playerGridX = Math.floor((player.x + player.size/2) / MAP.gridSize);
            const playerGridY = Math.floor((player.y + player.size/2) / MAP.gridSize);
            
            for (const obj of MAP.objects.filter(o => 
                o.type === 'closet' || o.type === 'bed' || o.type === 'sofa' || o.type === 'fridge')) {
                if (obj.floor !== player.floor) continue;
                
                if (Math.abs(obj.x - playerGridX) <= 1 && Math.abs(obj.y - playerGridY) <= 1) {
                    return true;
                }
            }
            return false;
        }
        
        function endGame(message) {
            clearInterval(timer);
            setTimeout(() => {
                alert(message);
                window.location.href = 'index.html';
            }, 500);
        }
        
        // === ЗАПУСК ===
        initFirebase();
        gameLoop();
        console.log('Игра запущена с Firebase синхронизацией');
    </script>
</body>
</html>
