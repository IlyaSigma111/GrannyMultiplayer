<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Granny 2D - –ò–≥—Ä–∞</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="game.css">
    <style>
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100%;
            background: #000;
        }
        
        .game-container {
            padding: 5px !important;
            max-width: none !important;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        #gameCanvas {
            flex-grow: 1;
            width: 100% !important;
            height: auto !important;
            max-height: 70vh;
            border: 2px solid #444;
        }
        
        .game-header {
            margin-bottom: 5px;
            padding: 8px 15px;
        }
        
        .controls {
            margin-top: 5px;
            padding: 5px;
        }
        
        .game-log {
            margin-top: 5px;
            max-height: 80px;
            padding: 8px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <div class="timer">
                <span id="timer">120</span> —Å–µ–∫
            </div>
            <div class="role">
                –í—ã: <span id="roleText">–í—ã–∂–∏–≤—à–∏–π</span>
            </div>
            <div class="players-online">
                –ò–≥—Ä–æ–∫–æ–≤: <span id="playersCount">1</span>
            </div>
            <button onclick="window.location.href='index.html'" style="padding:5px 10px; font-size:12px;">–í—ã–π—Ç–∏</button>
        </div>
        
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <div class="controls">
            <div class="desktop-controls">
                <p>WASD/–°—Ç—Ä–µ–ª–∫–∏ - –¥–≤–∏–≥–∞—Ç—å—Å—è, –ü–†–û–ë–ï–õ - —Å–ø—Ä—è—Ç–∞—Ç—å—Å—è, E - –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å</p>
            </div>
        </div>
        
        <div class="game-log" id="gameLog">
            <p id="debugText">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä—ã...</p>
        </div>
    </div>

    <script>
        // ===== –û–°–ù–û–í–ù–û–ô –ò–ì–†–û–í–û–ô –î–í–ò–ñ–û–ö =====
        console.log('=== Granny 2D Multiplayer ===');
        
        // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');
        const playerId = urlParams.get('player');
        const isGranny = urlParams.get('granny') === 'true';
        
        console.log('–ò–≥—Ä–æ–∫:', playerId, 'Granny:', isGranny, '–ö–æ–º–Ω–∞—Ç–∞:', roomId);
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        const roleElement = document.getElementById('roleText');
        const timerElement = document.getElementById('timer');
        const playersElement = document.getElementById('playersCount');
        const debugElement = document.getElementById('debugText');
        const logElement = document.getElementById('gameLog');
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        roleElement.textContent = isGranny ? 'Granny üëµ' : '–í—ã–∂–∏–≤—à–∏–π üèÉ';
        roleElement.style.color = isGranny ? '#ff4757' : '#00ff88';
        
        // –ö–∞–Ω–≤–∞—Å –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∫–∞—Ä—Ç—ã
        const MAP = {
            gridSize: 50, // –£–í–ï–õ–ò–ß–ò–õ–ò –° 40 –î–û 50
            width: 25,    // –£–í–ï–õ–ò–ß–ò–õ–ò –ö–ê–†–¢–£
            height: 20,
            
            rooms: [
                { id: 'entrance', name: '–ü—Ä–∏—Ö–æ–∂–∞—è', x: 10, y: 15, w: 7, h: 5, floor: 1 },
                { id: 'livingroom', name: '–ì–æ—Å—Ç–∏–Ω–∞—è', x: 5, y: 10, w: 10, h: 5, floor: 1 },
                { id: 'kitchen', name: '–ö—É—Ö–Ω—è', x: 15, y: 12, w: 8, h: 7, floor: 1 },
                { id: 'garage', name: '–ì–∞—Ä–∞–∂', x: 2, y: 15, w: 7, h: 5, floor: 1 },
                { id: 'bedroom', name: '–°–ø–∞–ª—å–Ω—è', x: 5, y: 3, w: 10, h: 7, floor: 2 },
                { id: 'bathroom', name: '–í–∞–Ω–Ω–∞—è', x: 16, y: 3, w: 7, h: 7, floor: 2 }
            ],
            
            objects: [
                // –î–≤–µ—Ä–∏
                { x: 13, y: 17, type: 'door', locked: false, room: 'entrance' },
                { x: 18, y: 15, type: 'door', locked: true, room: 'kitchen' },
                { x: 5, y: 17, type: 'door', locked: false, room: 'garage' },
                
                // –£–∫—Ä—ã—Ç–∏—è
                { x: 12, y: 16, type: 'closet', room: 'entrance' },
                { x: 17, y: 14, type: 'refrigerator', room: 'kitchen' },
                { x: 6, y: 16, type: 'car', room: 'garage' },
                { x: 8, y: 6, type: 'bed', room: 'bedroom' },
                { x: 18, y: 6, type: 'bathtub', room: 'bathroom' },
                
                // –õ–µ—Å—Ç–Ω–∏—Ü–∞
                { x: 13, y: 16, type: 'stairs', room: 'entrance' }
            ]
        };
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∫–∞–Ω–≤–∞—Å–∞ –ø–æ –∫–∞—Ä—Ç–µ
        canvas.width = MAP.width * MAP.gridSize;
        canvas.height = MAP.height * MAP.gridSize;
        
        console.log('–†–∞–∑–º–µ—Ä –∫–∞–Ω–≤–∞—Å–∞:', canvas.width, 'x', canvas.height);
        
        // –¢–µ–∫—É—â–∏–π –∏–≥—Ä–æ–∫
        const player = {
            id: playerId,
            x: 12 * MAP.gridSize,
            y: 16 * MAP.gridSize,
            size: 20, // –£–í–ï–õ–ò–ß–ò–õ–ò –†–ê–ó–ú–ï–†
            color: isGranny ? '#ff0000' : '#00a8ff',
            name: isGranny ? 'Granny' : 'Player_' + playerId.substring(0, 4),
            isGranny: isGranny,
            floor: 1,
            hidden: false,
            speed: isGranny ? 2.5 : 3.5, // Granny –º–µ–¥–ª–µ–Ω–Ω–µ–µ
            lastUpdate: Date.now()
        };
        
        // –î—Ä—É–≥–∏–µ –∏–≥—Ä–æ–∫–∏
        let otherPlayers = {};
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        const keys = {};
        let isMoving = false;
        
        window.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            keys[key] = true;
            isMoving = true;
            
            // –î–µ–π—Å—Ç–≤–∏—è
            if (key === ' ' || key === 'spacebar') {
                toggleHide();
            }
            if (key === 'e') {
                interact();
            }
        });
        
        window.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
            isMoving = Object.values(keys).some(v => v);
        });
        
        // –¢–∞–π–º–µ—Ä –∏–≥—Ä—ã
        let gameTime = 120;
        let gameActive = true;
        
        const gameTimer = setInterval(() => {
            if (!gameActive) return;
            
            gameTime--;
            timerElement.textContent = gameTime;
            
            if (gameTime <= 0) {
                endGame(isGranny ? '–í—ã–∂–∏–≤—à–∏–µ –ø–æ–±–µ–¥–∏–ª–∏! –í—Ä–µ–º—è –≤—ã—à–ª–æ.' : 'Granny –ø–æ–±–µ–¥–∏–ª–∞! –í—Ä–µ–º—è –≤—ã—à–ª–æ.');
            }
        }, 1000);
        
        // Firebase
        let firebaseLoaded = false;
        let database = null;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º Firebase
        import('./firebase.js').then(module => {
            console.log('Firebase –∑–∞–≥—Ä—É–∂–µ–Ω');
            firebaseLoaded = true;
            database = module.database;
            
            // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–º–Ω–∞—Ç–µ
            const { ref, onValue, update } = module;
            const roomRef = ref(database, 'rooms/' + roomId);
            
            onValue(roomRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) {
                    endGame('–ö–æ–º–Ω–∞—Ç–∞ —É–¥–∞–ª–µ–Ω–∞!');
                    return;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∏–≥—Ä–æ–∫–æ–≤
                if (data.players) {
                    const playerCount = Object.keys(data.players).length;
                    playersElement.textContent = playerCount;
                    
                    // –ü–æ–ª—É—á–∞–µ–º –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤
                    otherPlayers = {};
                    Object.entries(data.players).forEach(([id, playerData]) => {
                        if (id !== playerId && playerData.x !== undefined) {
                            otherPlayers[id] = {
                                x: playerData.x,
                                y: playerData.y,
                                floor: playerData.floor || 1,
                                hidden: playerData.hidden || false,
                                caught: playerData.caught || false,
                                isGranny: playerData.isGranny || false,
                                name: playerData.name || '–ò–≥—Ä–æ–∫'
                            };
                        }
                    });
                }
                
                // –ö–æ–Ω–µ—Ü –∏–≥—Ä—ã
                if (data.gameOver) {
                    endGame(data.gameResult || '–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞');
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä –∏–∑ Firebase
                if (data.timer !== undefined) {
                    gameTime = data.timer;
                }
            });
            
            // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ –∏–≥—Ä–æ–∫–∞
            window.updatePlayerPosition = () => {
                if (!firebaseLoaded) return;
                
                const updates = {
                    x: player.x,
                    y: player.y,
                    floor: player.floor,
                    hidden: player.hidden,
                    caught: false,
                    lastUpdate: Date.now(),
                    name: player.name
                };
                
                const playerRef = ref(database, `rooms/${roomId}/players/${playerId}`);
                update(playerRef, updates);
            };
            
        }).catch(err => {
            console.error('–û—à–∏–±–∫–∞ Firebase:', err);
            debugElement.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É';
        });
        
        // –§—É–Ω–∫—Ü–∏–∏ –∏–≥—Ä—ã
        function toggleHide() {
            if (player.hidden) {
                // –í—ã—Ö–æ–¥ –∏–∑ —É–∫—Ä—ã—Ç–∏—è
                player.hidden = false;
                addLog('–í—ã –≤—ã—à–ª–∏ –∏–∑ —É–∫—Ä—ã—Ç–∏—è');
            } else {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ —Å–ø—Ä—è—Ç–∞—Ç—å—Å—è
                const canHide = checkNearHideSpot();
                if (canHide) {
                    player.hidden = true;
                    addLog('–í—ã —Å–ø—Ä—è—Ç–∞–ª–∏—Å—å!');
                }
            }
        }
        
        function checkNearHideSpot() {
            // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - —Ä—è–¥–æ–º —Å –æ–±—ä–µ–∫—Ç–∞–º–∏ —É–∫—Ä—ã—Ç–∏—è
            for (const obj of MAP.objects) {
                if (obj.type === 'closet' || obj.type === 'bed' || obj.type === 'car') {
                    const dist = Math.sqrt(
                        Math.pow((player.x / MAP.gridSize) - obj.x, 2) + 
                        Math.pow((player.y / MAP.gridSize) - obj.y, 2)
                    );
                    if (dist < 2) return true;
                }
            }
            return false;
        }
        
        function interact() {
            if (player.hidden) {
                toggleHide();
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–≤–µ—Ä—å
            for (const obj of MAP.objects.filter(o => o.type === 'door')) {
                const dist = Math.sqrt(
                    Math.pow((player.x / MAP.gridSize) - obj.x, 2) + 
                    Math.pow((player.y / MAP.gridSize) - obj.y, 2)
                );
                
                if (dist < 1.5) {
                    if (obj.locked) {
                        addLog('–î–≤–µ—Ä—å –∑–∞–ø–µ—Ä—Ç–∞!');
                    } else if (obj.room === 'entrance' && !player.isGranny) {
                        endGame('–í—ã–∂–∏–≤—à–∏–µ —Å–±–µ–∂–∞–ª–∏! –ü–æ–±–µ–¥–∞!', 'survivors');
                    }
                }
            }
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
        function drawMap() {
            // –§–æ–Ω
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // –ö–æ–º–Ω–∞—Ç—ã
            MAP.rooms.forEach(room => {
                if (room.floor !== player.floor) return;
                
                const x = room.x * MAP.gridSize;
                const y = room.y * MAP.gridSize;
                const w = room.w * MAP.gridSize;
                const h = room.h * MAP.gridSize;
                
                // –ü–æ–ª
                ctx.fillStyle = room.id === 'entrance' ? '#1a1a1a' : '#222';
                ctx.fillRect(x, y, w, h);
                
                // –°—Ç–µ–Ω—ã
                ctx.strokeStyle = '#444';
                ctx.lineWidth = 3;
                ctx.strokeRect(x, y, w, h);
                
                // –ù–∞–∑–≤–∞–Ω–∏–µ
                ctx.fillStyle = '#888';
                ctx.font = '14px Arial';
                ctx.fillText(room.name, x + 10, y + 20);
            });
            
            // –û–±—ä–µ–∫—Ç—ã
            MAP.objects.forEach(obj => {
                const x = obj.x * MAP.gridSize;
                const y = obj.y * MAP.gridSize;
                
                switch (obj.type) {
                    case 'door':
                        ctx.fillStyle = obj.locked ? '#8B0000' : '#8B4513';
                        ctx.fillRect(x, y, MAP.gridSize, MAP.gridSize);
                        ctx.fillStyle = '#fff';
                        ctx.font = '20px Arial';
                        ctx.fillText('üö™', x + 15, y + 35);
                        break;
                        
                    case 'closet':
                        ctx.fillStyle = '#5D4037';
                        ctx.fillRect(x, y, MAP.gridSize, MAP.gridSize);
                        ctx.fillStyle = '#fff';
                        ctx.font = '20px Arial';
                        ctx.fillText('üö™', x + 15, y + 35);
                        break;
                        
                    case 'stairs':
                        ctx.fillStyle = '#555';
                        ctx.fillRect(x, y, MAP.gridSize, MAP.gridSize);
                        ctx.fillStyle = '#fff';
                        ctx.font = '20px Arial';
                        ctx.fillText('ü™ú', x + 15, y + 35);
                        break;
                }
            });
        }
        
        function drawPlayers() {
            // –î—Ä—É–≥–∏–µ –∏–≥—Ä–æ–∫–∏
            Object.values(otherPlayers).forEach(p => {
                if (p.floor !== player.floor || p.caught) return;
                
                const x = p.x;
                const y = p.y;
                
                // –¢–µ–Ω—å
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.beginPath();
                ctx.ellipse(x + 15, y + 35, 15, 6, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // –ò–≥—Ä–æ–∫
                ctx.fillStyle = p.isGranny ? '#ff0000' : '#00a8ff';
                ctx.beginPath();
                ctx.arc(x + 15, y + 15, p.hidden ? 8 : 15, 0, Math.PI * 2);
                ctx.fill();
                
                // –ò–º—è
                ctx.fillStyle = '#fff';
                ctx.font = '12px Arial';
                ctx.fillText(p.name, x - 10, y - 5);
                
                // –°–ø—Ä—è—Ç–∞–Ω–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                if (p.hidden) {
                    ctx.fillStyle = 'rgba(0,0,0,0.5)';
                    ctx.fillRect(x - 10, y - 10, 50, 50);
                }
            });
            
            // –¢–µ–∫—É—â–∏–π –∏–≥—Ä–æ–∫
            const x = player.x;
            const y = player.y;
            
            // –¢–µ–Ω—å
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath();
            ctx.ellipse(x + 15, y + 35, 15, 6, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // –ò–≥—Ä–æ–∫
            ctx.fillStyle = player.color;
            ctx.beginPath();
            ctx.arc(x + 15, y + 15, player.hidden ? 8 : player.size, 0, Math.PI * 2);
            ctx.fill();
            
            // –ò–º—è
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 14px Arial';
            ctx.fillText(player.name + ' (–í—ã)', x - 15, y - 10);
            
            // –°–ø—Ä—è—Ç–∞–Ω–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
            if (player.hidden) {
                ctx.fillStyle = 'rgba(0,0,0,0.7)';
                ctx.fillRect(x - 15, y - 15, 60, 60);
                ctx.fillStyle = '#fff';
                ctx.font = '12px Arial';
                ctx.fillText('–°–ø—Ä—è—Ç–∞–Ω', x, y - 20);
            }
        }
        
        function drawHUD() {
            // –≠—Ç–∞–∂
            ctx.fillStyle = '#fff';
            ctx.font = '16px Arial';
            ctx.fillText(`–≠—Ç–∞–∂ ${player.floor}`, 20, 30);
            
            // –û—Ç–ª–∞–¥–∫–∞
            ctx.font = '12px Arial';
            ctx.fillText(`X: ${Math.round(player.x)}, Y: ${Math.round(player.y)}`, 20, 50);
            ctx.fillText(`–°–∫–æ—Ä–æ—Å—Ç—å: ${player.speed}`, 20, 65);
            ctx.fillText(`–°–ø—Ä—è—Ç–∞–Ω: ${player.hidden ? '–î–∞' : '–ù–µ—Ç'}`, 20, 80);
        }
        
        // –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
        function gameLoop() {
            // –û—á–∏—Å—Ç–∫–∞
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è
            if (!player.hidden) {
                handleMovement();
            }
            
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
            drawMap();
            drawPlayers();
            drawHUD();
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è Granny
            if (player.isGranny) {
                checkCatch();
            }
            
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
            syncPlayer();
            
            requestAnimationFrame(gameLoop);
        }
        
        function handleMovement() {
            let moved = false;
            
            // WASD + –°—Ç—Ä–µ–ª–∫–∏
            if (keys['w'] || keys['arrowup']) {
                player.y -= player.speed;
                moved = true;
            }
            if (keys['s'] || keys['arrowdown']) {
                player.y += player.speed;
                moved = true;
            }
            if (keys['a'] || keys['arrowleft']) {
                player.x -= player.speed;
                moved = true;
            }
            if (keys['d'] || keys['arrowright']) {
                player.x += player.speed;
                moved = true;
            }
            
            // –ì—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ä—Ç—ã
            player.x = Math.max(0, Math.min(canvas.width - player.size * 2, player.x));
            player.y = Math.max(0, Math.min(canvas.height - player.size * 2, player.y));
            
            // –°–º–µ–Ω–∞ —ç—Ç–∞–∂–∞
            if (moved) {
                checkStairs();
            }
        }
        
        function checkStairs() {
            const gridX = Math.floor(player.x / MAP.gridSize);
            const gridY = Math.floor(player.y / MAP.gridSize);
            
            for (const obj of MAP.objects.filter(o => o.type === 'stairs')) {
                if (obj.x === gridX && obj.y === gridY) {
                    player.floor = player.floor === 1 ? 2 : 1;
                    addLog(`–ü–µ—Ä–µ—à–µ–ª –Ω–∞ ${player.floor} —ç—Ç–∞–∂`);
                    
                    // –¢–µ–ª–µ–ø–æ—Ä—Ç –Ω–∞ –¥—Ä—É–≥–æ–π —ç—Ç–∞–∂
                    if (player.floor === 2) {
                        player.x = 10 * MAP.gridSize;
                        player.y = 5 * MAP.gridSize;
                    } else {
                        player.x = 12 * MAP.gridSize;
                        player.y = 16 * MAP.gridSize;
                    }
                    break;
                }
            }
        }
        
        function checkCatch() {
            Object.entries(otherPlayers).forEach(([id, p]) => {
                if (p.isGranny || p.caught || p.hidden || p.floor !== player.floor) return;
                
                const dist = Math.sqrt(
                    Math.pow(player.x - p.x, 2) + 
                    Math.pow(player.y - p.y, 2)
                );
                
                if (dist < 30) {
                    addLog(`${p.name} –ø–æ–π–º–∞–Ω!`);
                    // –í —Ä–µ–∞–ª—å–Ω–æ–π –∏–≥—Ä–µ —Ç—É—Ç –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å Firebase
                }
            });
        }
        
        function syncPlayer() {
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–µ 100–º—Å
            if (Date.now() - player.lastUpdate > 100) {
                player.lastUpdate = Date.now();
                
                if (window.updatePlayerPosition) {
                    window.updatePlayerPosition();
                }
            }
        }
        
        function addLog(message) {
            const now = new Date();
            const time = `${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;
            
            const p = document.createElement('p');
            p.textContent = `[${time}] ${message}`;
            logElement.appendChild(p);
            
            // –õ–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π
            while (logElement.children.length > 10) {
                logElement.removeChild(logElement.firstChild);
            }
            
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function endGame(message, winner) {
            gameActive = false;
            clearInterval(gameTimer);
            
            addLog(`=== ${message} ===`);
            
            setTimeout(() => {
                alert(message + '\n\n–í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –ª–æ–±–±–∏...');
                window.location.href = 'index.html';
            }, 2000);
        }
        
        // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã
        gameLoop();
        addLog(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –¥–æ–º Granny!`);
        addLog(`–í—ã ${isGranny ? 'Granny' : '–≤—ã–∂–∏–≤—à–∏–π'}. ${isGranny ? '–õ–æ–≤–∏—Ç–µ –¥—Ä—É–≥–∏—Ö!' : '–ü—Ä—è—á—å—Ç–µ—Å—å –∏ —É–±–µ–≥–∞–π—Ç–µ!'}`);
        debugElement.textContent = `–ò–≥—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞ | X:${player.x} Y:${player.y}`;
        
        console.log('–ò–≥—Ä–æ–≤–æ–π –¥–≤–∏–∂–æ–∫ –∑–∞–ø—É—â–µ–Ω');
    </script>
</body>
</html>
